# ReCall Deployment Guide (Vercel)

This guide covers how to deploy ReCall to Vercel with all production-grade infrastructure properly connected.

## 1. Prerequisites Checklist

- [ ] **Vercel Account**: [vercel.com](https://vercel.com)
- [ ] **CockroachDB Cluster**: [cockroachlabs.com](https://cockroachlabs.com) (Serverless is fine)
- [ ] **Pinecone Index**: [pinecone.io](https://pinecone.io)
- [ ] **Upstash Redis**: [upstash.com](https://upstash.com) (For session state)
- [ ] **Google Cloud Project**: For Vertex AI (Gemini)
- [ ] **ElevenLabs Account**: For premium speech synthesis

---

## 2. Infrastructure Setup

### Database (CockroachDB)
1. Create a serverless cluster.
2. Create a database named `recall_prod`.
3. Get the Connection String. It looks like:
   `postgresql://user:password@host:26257/recall_prod?sslmode=verify-full`

### Vector Store (Pinecone)
1. Create an index named `recall-memory`.
2. Dimension: **768** (for Google Gecko embeddings) or **1536** (if using OpenAI). *ReCall defaults to Google Gecko (768).*
3. Metric: `cosine`.

### Redis (Upstash)
1. Create a Redis database.
2. Copy the `REDIS_URL`.

---

## 3. Environment Variables

Configure these in your Vercel Project Settings > Environment Variables.

### Core
| Variable | Description | Example |
|----------|-------------|---------|
| `NODE_ENV` | Environment mode | `production` |
| `NEXT_PUBLIC_APP_URL` | Your production URL | `https://recall-app.vercel.app` |
| `NEXTAUTH_URL` | Same as App URL | `https://recall-app.vercel.app` |
| `NEXTAUTH_SECRET` | 32-char random string | `openssl rand -base64 32` |
| `JWT_SECRET` | 32-char random string | `(same as above or different)` |
| `CRON_SECRET` | Auto-generated by Vercel | (Vercel adds this automatically for cron jobs) |

### Databases
| Variable | Description |
|----------|-------------|
| `DATABASE_URL` | CockroachDB connection string |
| `REDIS_URL` | Upstash Redis URL (`redis://...`) |
| `PINECONE_API_KEY` | Your Pinecone API Key |

### AI Providers (Gemini via Vertex AI)
*Note: You requested Vertex AI. This uses Google Cloud authentication.*
| Variable | Description |
|----------|-------------|
| `LLM_PROVIDER` | Set to `vertex` |
| `GOOGLE_CLOUD_PROJECT` | Your GCP Project ID |
| `GOOGLE_APPLICATION_CREDENTIALS` | JSON key for service account (base64 encoded recommended) |

*Alternative: If using Google AI Studio API Key:*
| Variable | Description |
|----------|-------------|
| `GOOGLE_AI_API_KEY` | Your Gemini API Key string |
| `LLM_PROVIDER` | Set to `google_ai` |

### Speech (ElevenLabs)
| Variable | Description |
|----------|-------------|
| `SPEECH_PROVIDER` | Set to `elevenlabs` |
| `ELEVENLABS_API_KEY` | Your ElevenLabs API Key |

---

## 4. Deployment Steps

1. **Push Code**: Push your latest code to GitHub/GitLab.
2. **Import Project**: In Vercel, import the repository.
3. **Configure Env Vars**: Add all variables from Section 3.
4. **Deploy**: Click Deploy.
5. **Database Migration**:
   - Vercel build will NOT automatically migrate production DBs for safety.
   - Run from your local machine (pointing to prod DB):
     ```bash
     DATABASE_URL="your-cockroach-url" npm run db:push
     ```

## 5. Verification

1. **Check Cron Jobs**: In Vercel Dashboard > Project > Settings > Cron Jobs. You should see `/api/cron/process-jobs`.
2. **Test Session**: Start a session, speak, and ensure transcription works.
3. **End Session**: Click "End & Save". Wait 1-2 minutes. The chapter should appear in "Stories" (generated via background job).

---

## 6. Troubleshooting

- **Rate Limits**: Check Vercel logs. The app now has built-in retries with exponential backoff.
- **504 Gateway Timeout**: If background jobs take >10s, verify they are offloaded to Vercel Cron processing logic.
